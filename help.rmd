---
title: "secr app 1.0"
author: "Murray Efford"
date: '2019-02-01'
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    toc: yes
    toc_depth: 2
---

# An interactive app for spatially explicit capture--recapture

## Murray Efford 2019-02-01

# Contents
  [Introduction](#introduction)  
  [Main screen](#main)  
  [Habitat mask](#habitatmask)  
  [Summary](#summary)  
  [Options](#optionspecs)  
  [Troubleshooting](#troubles)  
  [References](#references)  
  
----------------------------------------------------

# Introduction  <a name="introduction"></a>

This Shiny application is an interactive interface to parts of the R package **secr** ([Efford 2019a](#references)). It fits simple single-session models. The current source code is available from https://GitHub.com/MurrayEfford/secrapp.

Tip: on small displays, running your browser in full-screen mode will avoid the need to scroll down (often F11 will get you there; otherwise try the options menu).

# Main screen  <a name="main"></a>

*Use settings on this page to input data and fit simple models.*

## Data input

### Trap layout

The detector layout is input from a text file. The file typically should have three columns (trapID, x, y) with no headers. Optional arguments separated by commas may be used to customise input (e.g., `skip`, which is passed through `read.traps` to `read.table`). 

Options for <u>detector type</u>  follow **secr** ([Efford (2019b)](#references)): "multi" refers to a multi-catch trap; "proximity" to binary proximity detectors, and "count" to detectors that yield integer counts. Counts are assumed to be Poisson-distributed.

### Captures

Detections ('captures') of known individuals are also input from a text file. Two formats are allowed, as in DENSITY or **secr**.


## Model
            
<table style="width:50%">
  <tr>
    <td> Detection function </td>
    <td> HHN &nbsp; hazard halfnormal &nbsp; \( \small \lambda(d) = -\lambda_0 \exp\{-d^2/(2\sigma^2)\} \) </td>
  </tr>
  <tr>
    <td> </td>
    <td> HEX &nbsp; hazard negative exponential  &nbsp; \( \small \lambda(d) = -\lambda_0 \exp(-d/\sigma) \) </td>
  </tr>
  <tr>
    <td>Likelihood</td>
    <td>maximize full likelihood or likelihood conditional on \(n\)</td>
  </tr>
  <tr>
    <td>Distribution</td>
    <td>distribution of number detected \(n\)</td>
  </tr>
  <tr>
    <td>Function</td>
    <td>choose between functions used to fit model (packages secr and openCR)</td>
  </tr>
</table> 

<br>

Only two <u>detection functions</u> are supported: 'HHN' and 'HEX'. These relate an animal's hazard of detection at a particular detector on a particular sampling occasion (\(\lambda\)) to the distance \(\small d\) of the detector from its home-range centre. The corresponding probability of detection is \(\small g(d) = 1 - \exp \{ - \lambda(d)\}\).

<a name="distribution"></a>

The <u>Distribution</u> radio button toggles between two models for the number of detected individuals $n$. The "Binomial" option corresponds to fixed number $N$ in the masked area and a binomial point process for the distribution of activity centres.  The "Poisson" option corresponds to Poisson $N$ and a Poisson point process for activity centres. 


## Actions

<table style="width:40%">
  <tr>
    <td>Fit model</td>
    <td>Fit closed-population SECR model</td>
  </tr>
  <tr>
    <td>Add to summary</td>
    <td>Transfer results to summary table[Not working]</td>
  </tr>
  <tr>
    <td>Reset all</td>
    <td>Reset all input options to defaults (except file inputs)</td>
  </tr>
  <tr>
    <td>Bookmark</td>
    <td> (see Bookmarking)</td>
  </tr>
</table> 

<br>

## Results  <a name="results"></a>

*Values in the Results window are updated automatically when the inputs change.*

Results vary depending on the inputs

* summary of detector layout only
* summary of capthist object (detector layout + detections)
* summary of fitted model

## Tabbed plots

*Plots update automatically. Any plot may be saved by right-clicking on the image.*

[NOT ALL PLOTS ARE WORKING 2019-02-01]

### Array

A plot of the current detector layout. Detections are overplotted if they have been uploaded.

### Detectfn   <a name="detectfnplot"></a>

Fitted detection function on the hazard scale

### Popn

One simulated realisation of a uniformly distributed population from the fitted model.

### Pxy

Contours of the overall detection probability \(p_\cdot(\mathbf x)\) under the fitted model ('Pxy' is the label that has been used for this quantity in the Windows application Density).  Settings in Options toggle the display between filled and unfilled contour plots, and determine whether contours are labelled. The requested contour levels are 0.1, 0.2, ..., 0.9, but higher contours may be missing. Click on the plot to find the value at a point.

### Power

Two styles of plot are offered (see Options | Power plot)

#### Power for test of null hypothesis 

Probability of detecting a change in density in a 2-survey comparison as a function of effect size for a given expected \(\small \mbox{RSE}(\hat D)\). See [Appendix 1](#appendix1) for the computation method.

Effect size is the ratio of final density \(\small D_2\) to initial density \(\small D_1\) expressed as a percentage. The alpha level is specified in Options (default \(\small \alpha = 0.05\)). 

The curve is initially computed for the rule-of-thumb RSE from the current design. Use the slider to vary this. Especially, consider adding a safety margin for underestimation of RSE.

The default method assumes that \(\small \mbox{RSE}(\hat D)\) is the same in the initial and final surveys. It is more likely that \(\small \mbox{RSE}(\hat D)\) will increase as density declines. An adjustment is applied to the final RSE when the 'Adjust RSE' box is ticked:  \(\small \mbox{RSE}(\hat D_2) =   \sqrt {D_1/D_2} \mbox{RSE}(\hat D_1) \).

#### Confidence interval for population change

As an alternative to conventional power analysis we can construct intervals for the estimated ratio of densities, given the true ratio and the sampling errors. The interval is the region between the upper and lower curves for a given true population change on the x axis. 

----------------------------------------------------

# Habitat mask  <a name="habitatmask"></a>

----------------------------------------------------

# Summary  <a name="summary"></a>

The table on this page has one column for each model fit or other summary; summaries are added by clicking the 'Add to summary' button on the [Main screen](#main), or automatically when models are fitted. Some fields will have missing values if no model has been fitted.

The table may be downloaded as a comma-separated text file or in the RDS format (use `readRDS` to restore in R). The table is transposed on download so that scenarios become rows.

----------------------------------------------------

# Options  <a name="optionspecs"></a>

*These should be self-explanatory. Experiment if in doubt.*

----------------------------------------------------

# Troubleshooting <a name="troubles"></a>

Here are some known pitfalls

## Bookmark fails with shapefile polygons

This is a known bug that cannot be addressed immediately. It is avoided by saving SpatialPolygons as .rds or .rdata files.

## Components of a shapefile must be selected and uploaded together

At least .shp, .dbf and .shx.

## No exclusion option for habitat mask

A systematic or random array defined with a Region polygon may exclude sites that lie within other polygons (Options | Detector array | Excluded region). How is an exclusion applied to the habitat mask? Unfortunately the **secr** function `make.mask` accepts only one polygon input, although this may represent either habitat or non-habitat. To combine habitat (inclusion) and non-habitat (exclusion) polygons you will first need to use GIS software (e.g., the `gDifference` function in the R package **rgeos**) and save the result as a single SpatialPolygons object (e.g., as an .rds file).

```{r, eval = FALSE}
library(rgdal)
library(rgos)
setwd('d:/density secr 3.2/secrdesignapp')
region <- rgdal::readOGR(dsn = 'OVforest.shp')
# coordinates from text file
coord <- read.table('excltest.txt')   # read boundary coordinates
excluded <- secr:::boundarytoSP(coord)  # convert to SpatialPolygons
newpoly <- gDifference (region, excluded)
saveRDS(newpoly, file = 'newpoly.RDS')
```

The RDS file may then be used in Habitat mask.

# Bookmarking  <a name="bookmark"></a>

Bookmarking creates a URL that allows you to take up your session where you left off. 

Bookmarking can be tricky. When running from GitHub on a local machine your should specify the arguments `port` and `destdir` both in the initial session that you bookmark and later when you restore it, e.g.,

```{r, eval = FALSE}
library(shiny)
runGitHub("secrdesignapp", "MurrayEfford", port = 8000, destdir = "d:/myworkingfolder")
```

The port number is arbitrary. Bookmarks are stored in a subdirectory of destdir. The URL generated by pressing the Bookmark button may be entered into your browser once you have started a new session with the same 'port' and 'destdir'. This restores all input settings and the Summary table. Also consider setting `options(shiny.port = xxxx)`. The port used by a local bookmark is saved in the values.rds file of the bookmark; if you forget it, try `readRDS("values.rds")$port`.

----------------------------------------------------
# References <a name="references"></a>

Borchers, D. L. and Efford, M. G. (2008) Spatially explicit
   maximum likelihood methods for capture--recapture
   studies. *Biometrics* **64**, 377--385.
   
Efford, M. G. (2018) openCR: Open population capture--recapture models. R package version 1.3.2. https://CRAN.R-project.org/package=openCR

Efford, M. G. (2019a) secrdesign: Sampling design for spatially explicit
  capture--recapture. R package version 2.5.7.
  https://CRAN.R-project.org/package=secrdesign

Efford, M. G. (2019b) secr: Spatially explicit capture--recapture models. R package version 3.2.0. https://CRAN.R-project.org/package=secr

Efford, M. G. (2019c) Non-circular home ranges and the estimation of population density. *Ecology* (in press).

----------------------------------------------------

# Appendix 1. Power calculation for comparison of two density estimates <a name="appendix1"></a>

We want to predict the power of a comparison between two independent surveys as a function of the effect size (\( \small D_{21}\) = final density as fraction of initial density) and the predicted precision of the estimates, expressed as relative standard error RSE. The power calculation assumes log-normal errors in both the initial and final surveys. Log-normal errors are natural for estimates of density (we use a log link function for maximising the likelihood, and rely on symmetrical Wald intervals on the log scale).

For a log normal distribution the variance on the log scale is \( \small \sigma^2 = \log (1 + \mbox{CV}^2) \) where CV is the coefficient of variation on the arithmetic scale (equivalent here to RSE).

The mean \(\mu\) on the log scale is related to the mean \(m\) on the arithmetic scale by \( \small \mu = \log \frac{m}{\sqrt { 1 + \mbox{CV}^2}} \).

We conduct a \(z\)-test on the log scale. The effect size is \( \small \mu_2 - \mu_1 \). In general we must allow for differing RSE in the two surveys, which affects both the effect size and its variance, as follows.

$$ \small \mu_2 - \mu_1 = \log \frac{m_2}{\sqrt {1 + \mbox{CV}_2^2}} - \log \frac{m_1}{\sqrt {1 + \mbox{CV}_1^2}}. $$
This reduces to 
$$ \small \mu_2 - \mu_1 = \log \frac{m_2}{m_1} + \log \frac{\sqrt {1 + \mbox{CV}_1^2}}{\sqrt {1 + \mbox{CV}_2^2}}. $$
For equal CV the second term drops out.

The variance of the effect on the log scale is approximated by the sum of the respective variances:

$$ \small \sigma_{21}^2 = \log(1 + \mbox{CV}_1^2) + \log(1 + \mbox{CV}_2^2).$$
The standardised difference on the log scale \( \frac{\mu_2 - \mu_1}{\sigma_{21}} \) is compared to a standard normal variate at the desired alpha level.

In our application we replace \( \small m_2 / m_1 \) by \( \small D_{21}\) and \( \small \mbox{CV}_1 \) by RSE. 

To adjust for density-dependent RSE we assume that a difference in RSE between surveys is inversely proportional to the square root of \( \small D_{21} \) (this follows the logic of the rule-of-thumb in which both \(n\) and \(r\) scale with density). Thus \( \small \mbox{CV}_2 = \mbox{RSE} / \sqrt{D_{21}} \).

--------------------------------------------------------------
[secrdesign-Enrm.pdf]: http://www.otago.ac.nz/density/pdfs/secrdesign-tools.pdf
